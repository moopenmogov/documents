<!DOCTYPE html>
<html>
<head>
    <title>State Matrix Validation Test</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .test-section { margin: 20px 0; border: 1px solid #ccc; padding: 15px; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .header { background: #f0f0f0; padding: 10px; margin: -15px -15px 15px -15px; }
        pre { background: #f8f8f8; padding: 10px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f0f0f0; }
        .scenario { font-weight: bold; color: #333; }
    </style>
</head>
<body>
    <h1>üß™ State Matrix Validation Test Suite</h1>
    <p>This tests that the API service produces identical results to the web viewer's state matrix logic.</p>
    
    <div id="results"></div>
    
    <script>
        // Mock current users for testing
        const mockUsers = {
            web: {
                'user1': { id: 'user1', name: 'Warren Peace', email: 'warren@opengov.com', role: 'editor' },
                'user2': { id: 'user2', name: 'Gettysburger King', email: 'gettysburger@opengov.com', role: 'viewer' },
                'user5': { id: 'user5', name: 'Yuri Lee Laffed', email: 'reese@opengov.com', role: 'suggester' },
                'vendor1': { id: 'vendor1', name: 'Mo--T', email: 'moti@real.builders', role: 'vendor' }
            },
            word: {
                'user3': { id: 'user3', name: 'Phil A Minyon', email: 'phil@opengov.com', role: 'editor' },
                'user4': { id: 'user4', name: 'Dee Nial', email: 'dee@opengov.com', role: 'viewer' },
                'user6': { id: 'user6', name: 'Boregard Snoozington', email: 'chuck@opengov.com', role: 'suggester' },
                'vendor2': { id: 'vendor2', name: 'Hari Seldon', email: 'hari@sel.don', role: 'vendor' }
            }
        };

        // Copy the web viewer's state matrix function for comparison
        function getWebViewerStateMatrix(userRole, platform, documentState, currentUser) {
            const { isCheckedOut, checkedOutBy, checkedOutUser } = documentState;
            
            // Determine if this is self-checkout
            const isSelfCheckout = isCheckedOut && (
                (checkedOutBy === platform && checkedOutUser?.id === currentUser?.id) ||
                (checkedOutBy === 'vendor' && currentUser?.role === 'vendor' && checkedOutUser?.id === currentUser?.id)
            );
            
            // Initialize result
            const result = {
                buttons: {
                    checkoutBtn: false,
                    overrideBtn: false, 
                    sendVendorBtn: false,
                    checkedInBtns: false
                },
                banner: {
                    text: '',
                    show: false
                }
            };
            
            // VIEWERS - Always read-only, role-specific banners
            if (userRole === 'viewer') {
                result.banner.show = true;
                if (!isCheckedOut) {
                    result.banner.text = 'u no change this';
                } else if (checkedOutBy === 'word' && platform === 'web') {
                    result.banner.text = 'u no change this - also checked out by word';
                } else if (checkedOutBy === 'web' && platform === 'word') {
                    result.banner.text = 'web has the doc locked up';
                } else if (checkedOutBy === 'web' && platform === 'web') {
                    result.banner.text = 'u no change this - doc checked out';
                } else if (checkedOutBy === 'word' && platform === 'word') {
                    result.banner.text = 'another word user has doc';
                } else if (checkedOutBy === 'vendor') {
                    result.banner.text = 'vendor be redlining';
                }
                return result;
            }
            
            // EDITORS - Full privileges, can override others
            if (userRole === 'editor') {
                if (!isCheckedOut) {
                    result.buttons.checkoutBtn = true;
                    result.buttons.sendVendorBtn = true;
                } else if (isSelfCheckout) {
                    result.buttons.checkedInBtns = true;
                } else {
                    result.buttons.overrideBtn = true;
                    result.banner.show = true;
                    
                    if (checkedOutBy === 'word' && platform === 'web') {
                        result.banner.text = "YA CAN'T SAVE HERE FORREST -- WORD GOT YA DOC!";
                    } else if (checkedOutBy === 'web' && platform === 'word') {
                        result.banner.text = 'web viewer has doc locked';
                    } else if (checkedOutBy === 'web' && platform === 'web') {
                        result.banner.text = 'doc doc u ... right here right meow';
                    } else if (checkedOutBy === 'word' && platform === 'word') {
                        result.banner.text = 'another word user has doc';
                    } else if (checkedOutBy === 'vendor') {
                        result.banner.text = 'vendor be redlining';
                    }
                }
                return result;
            }
            
            // SUGGESTERS & VENDORS - Can checkout, no override privilege
            if (userRole === 'suggester' || userRole === 'vendor') {
                if (!isCheckedOut) {
                    result.buttons.checkoutBtn = true;
                } else if (isSelfCheckout) {
                    result.buttons.checkedInBtns = true;
                } else {
                    result.banner.show = true;
                    
                    if (checkedOutBy === 'word' && platform === 'web') {
                        result.banner.text = "YA CAN'T SAVE HERE FORREST -- WORD GOT YA DOC!";
                    } else if (checkedOutBy === 'web' && platform === 'word') {
                        result.banner.text = 'web viewer has doc locked';
                    } else if (checkedOutBy === 'web' && platform === 'web') {
                        result.banner.text = 'doc doc u ... right here right meow';
                    } else if (checkedOutBy === 'word' && platform === 'word') {
                        result.banner.text = 'another word user has doc';
                    } else if (checkedOutBy === 'vendor') {
                        result.banner.text = 'vendor be redlining';
                    }
                }
                return result;
            }
            
            console.warn(`‚ö†Ô∏è Unknown user role: ${userRole}`);
            return result;
        }

        // Test scenarios from USER_STATE_MATRIX.md
        const testScenarios = [
            // Web Viewer scenarios
            { userRole: 'viewer', platform: 'web', userId: 'user2', docState: { isCheckedOut: false }, description: 'Web Viewer - Available' },
            { userRole: 'viewer', platform: 'web', userId: 'user2', docState: { isCheckedOut: true, checkedOutBy: 'word', checkedOutUser: {id: 'user3'} }, description: 'Web Viewer - Word Checkout' },
            { userRole: 'viewer', platform: 'web', userId: 'user2', docState: { isCheckedOut: true, checkedOutBy: 'web', checkedOutUser: {id: 'user1'} }, description: 'Web Viewer - Web Checkout (other)' },
            { userRole: 'viewer', platform: 'web', userId: 'user2', docState: { isCheckedOut: true, checkedOutBy: 'vendor', checkedOutUser: {id: 'vendor1'} }, description: 'Web Viewer - Vendor Checkout' },
            
            // Web Editor scenarios
            { userRole: 'editor', platform: 'web', userId: 'user1', docState: { isCheckedOut: false }, description: 'Web Editor - Available' },
            { userRole: 'editor', platform: 'web', userId: 'user1', docState: { isCheckedOut: true, checkedOutBy: 'word', checkedOutUser: {id: 'user3'} }, description: 'Web Editor - Word Checkout' },
            { userRole: 'editor', platform: 'web', userId: 'user1', docState: { isCheckedOut: true, checkedOutBy: 'web', checkedOutUser: {id: 'user1'} }, description: 'Web Editor - Web Checkout (self)' },
            { userRole: 'editor', platform: 'web', userId: 'user1', docState: { isCheckedOut: true, checkedOutBy: 'web', checkedOutUser: {id: 'user5'} }, description: 'Web Editor - Web Checkout (other)' },
            { userRole: 'editor', platform: 'web', userId: 'user1', docState: { isCheckedOut: true, checkedOutBy: 'vendor', checkedOutUser: {id: 'vendor1'} }, description: 'Web Editor - Vendor Checkout' },
            
            // Web Suggester scenarios
            { userRole: 'suggester', platform: 'web', userId: 'user5', docState: { isCheckedOut: false }, description: 'Web Suggester - Available' },
            { userRole: 'suggester', platform: 'web', userId: 'user5', docState: { isCheckedOut: true, checkedOutBy: 'word', checkedOutUser: {id: 'user3'} }, description: 'Web Suggester - Word Checkout' },
            { userRole: 'suggester', platform: 'web', userId: 'user5', docState: { isCheckedOut: true, checkedOutBy: 'web', checkedOutUser: {id: 'user5'} }, description: 'Web Suggester - Web Checkout (self)' },
            { userRole: 'suggester', platform: 'web', userId: 'user5', docState: { isCheckedOut: true, checkedOutBy: 'web', checkedOutUser: {id: 'user1'} }, description: 'Web Suggester - Web Checkout (other)' },
            
            // Word Editor scenarios
            { userRole: 'editor', platform: 'word', userId: 'user3', docState: { isCheckedOut: false }, description: 'Word Editor - Available' },
            { userRole: 'editor', platform: 'word', userId: 'user3', docState: { isCheckedOut: true, checkedOutBy: 'web', checkedOutUser: {id: 'user1'} }, description: 'Word Editor - Web Checkout' },
            { userRole: 'editor', platform: 'word', userId: 'user3', docState: { isCheckedOut: true, checkedOutBy: 'word', checkedOutUser: {id: 'user3'} }, description: 'Word Editor - Word Checkout (self)' },
            { userRole: 'editor', platform: 'word', userId: 'user3', docState: { isCheckedOut: true, checkedOutBy: 'word', checkedOutUser: {id: 'user6'} }, description: 'Word Editor - Word Checkout (other)' },
            { userRole: 'editor', platform: 'word', userId: 'user3', docState: { isCheckedOut: true, checkedOutBy: 'vendor', checkedOutUser: {id: 'vendor2'} }, description: 'Word Editor - Vendor Checkout' },
            
            // Word Viewer scenarios
            { userRole: 'viewer', platform: 'word', userId: 'user4', docState: { isCheckedOut: false }, description: 'Word Viewer - Available' },
            { userRole: 'viewer', platform: 'word', userId: 'user4', docState: { isCheckedOut: true, checkedOutBy: 'web', checkedOutUser: {id: 'user1'} }, description: 'Word Viewer - Web Checkout' },
            { userRole: 'viewer', platform: 'word', userId: 'user4', docState: { isCheckedOut: true, checkedOutBy: 'word', checkedOutUser: {id: 'user3'} }, description: 'Word Viewer - Word Checkout (other)' },
            { userRole: 'viewer', platform: 'word', userId: 'user4', docState: { isCheckedOut: true, checkedOutBy: 'vendor', checkedOutUser: {id: 'vendor2'} }, description: 'Word Viewer - Vendor Checkout' }
        ];

        async function testAPIEndpoint(userRole, platform, userId, docState) {
            try {
                const url = `http://localhost:3001/api/state-matrix?userRole=${userRole}&platform=${platform}&userId=${userId}`;
                const response = await fetch(url);
                const data = await response.json();
                return data.success ? data.config : null;
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }

        function compareConfigs(api, webViewer, description) {
            const differences = [];
            
            // Compare buttons
            for (const [key, value] of Object.entries(api.buttons)) {
                if (value !== webViewer.buttons[key]) {
                    differences.push(`buttons.${key}: API=${value}, WebViewer=${webViewer.buttons[key]}`);
                }
            }
            
            // Compare banner
            if (api.banner.show !== webViewer.banner.show) {
                differences.push(`banner.show: API=${api.banner.show}, WebViewer=${webViewer.banner.show}`);
            }
            if (api.banner.text !== webViewer.banner.text) {
                differences.push(`banner.text: API="${api.banner.text}", WebViewer="${webViewer.banner.text}"`);
            }
            
            return {
                match: differences.length === 0,
                differences
            };
        }

        async function runTests() {
            const results = document.getElementById('results');
            let passCount = 0;
            let failCount = 0;
            
            results.innerHTML = '<h2>üîÑ Running tests...</h2>';
            
            const testResults = [];
            
            for (const scenario of testScenarios) {
                const { userRole, platform, userId, docState, description } = scenario;
                const currentUser = mockUsers[platform][userId];
                
                // Get API result
                const apiResult = await testAPIEndpoint(userRole, platform, userId, docState);
                
                // Get web viewer result
                const webViewerResult = getWebViewerStateMatrix(userRole, platform, docState, currentUser);
                
                if (!apiResult) {
                    testResults.push({
                        description,
                        status: 'ERROR',
                        message: 'API call failed'
                    });
                    failCount++;
                    continue;
                }
                
                // Compare results
                const comparison = compareConfigs(apiResult, webViewerResult, description);
                
                if (comparison.match) {
                    testResults.push({
                        description,
                        status: 'PASS',
                        apiResult,
                        webViewerResult
                    });
                    passCount++;
                } else {
                    testResults.push({
                        description,
                        status: 'FAIL',
                        differences: comparison.differences,
                        apiResult,
                        webViewerResult
                    });
                    failCount++;
                }
            }
            
            // Display results
            let html = `
                <h2>üìä Test Results</h2>
                <p><span class="pass">‚úÖ Passed: ${passCount}</span> | <span class="fail">‚ùå Failed: ${failCount}</span></p>
            `;
            
            testResults.forEach(result => {
                const statusClass = result.status === 'PASS' ? 'pass' : 'fail';
                html += `
                    <div class="test-section">
                        <div class="header">
                            <span class="scenario">${result.description}</span> 
                            <span class="${statusClass}">[${result.status}]</span>
                        </div>
                `;
                
                if (result.status === 'FAIL') {
                    html += `
                        <h4>‚ùå Differences:</h4>
                        <ul>
                            ${result.differences.map(diff => `<li>${diff}</li>`).join('')}
                        </ul>
                        <h4>API Result:</h4>
                        <pre>${JSON.stringify(result.apiResult, null, 2)}</pre>
                        <h4>Web Viewer Result:</h4>
                        <pre>${JSON.stringify(result.webViewerResult, null, 2)}</pre>
                    `;
                } else if (result.status === 'ERROR') {
                    html += `<p class="fail">${result.message}</p>`;
                } else {
                    html += `
                        <h4>‚úÖ Both systems returned:</h4>
                        <pre>${JSON.stringify(result.apiResult, null, 2)}</pre>
                    `;
                }
                
                html += '</div>';
            });
            
            results.innerHTML = html;
            
            if (failCount === 0) {
                results.innerHTML += '<div class="test-section"><div class="pass">üéâ All tests passed! API service matches web viewer exactly.</div></div>';
            }
        }

        // Auto-run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>
