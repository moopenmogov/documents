<!DOCTYPE html>
<html>
<head>
    <title>State Matrix Logic Validation</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .test-section { margin: 15px 0; padding: 10px; border: 1px solid #ccc; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .scenario { font-weight: bold; margin-bottom: 10px; }
        pre { background: #f8f8f8; padding: 8px; margin: 5px 0; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 12px; }
        th { background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>üß™ State Matrix Logic Validation</h1>
    <p>Testing that our state matrix logic matches the documented requirements from USER_STATE_MATRIX.md</p>
    
    <div id="results"></div>
    
    <script>
        // State matrix logic (copied from what we plan to put in the API)
        function getStateMatrixConfig(userRole, platform, docState, currentUser) {
            const { isCheckedOut, checkedOutBy, checkedOutUser } = docState;
            
            // Determine if this is self-checkout
            const isSelfCheckout = isCheckedOut && (
                (checkedOutBy === platform && checkedOutUser?.id === currentUser?.id) ||
                (checkedOutBy === 'vendor' && currentUser?.role === 'vendor' && checkedOutUser?.id === currentUser?.id)
            );
            
            // Initialize result
            const result = {
                buttons: {
                    checkoutBtn: false,
                    overrideBtn: false, 
                    sendVendorBtn: false,
                    checkedInBtns: false
                },
                banner: {
                    text: '',
                    show: false
                }
            };
            
            // VIEWERS - Always read-only, role-specific banners
            if (userRole === 'viewer') {
                result.banner.show = true;
                if (!isCheckedOut) {
                    result.banner.text = 'u no change this';
                } else if (checkedOutBy === 'word' && platform === 'web') {
                    result.banner.text = 'u no change this - also checked out by word';
                } else if (checkedOutBy === 'web' && platform === 'word') {
                    result.banner.text = 'web has the doc locked up';
                } else if (checkedOutBy === 'web' && platform === 'web') {
                    result.banner.text = 'u no change this - doc checked out';
                } else if (checkedOutBy === 'word' && platform === 'word') {
                    result.banner.text = 'another word user has doc';
                } else if (checkedOutBy === 'vendor') {
                    result.banner.text = 'vendor be redlining';
                }
                return result;
            }
            
            // EDITORS - Full privileges, can override others
            if (userRole === 'editor') {
                if (!isCheckedOut) {
                    result.buttons.checkoutBtn = true;
                    result.buttons.sendVendorBtn = true;
                } else if (isSelfCheckout) {
                    result.buttons.checkedInBtns = true;
                } else {
                    result.buttons.overrideBtn = true;
                    result.banner.show = true;
                    
                    if (checkedOutBy === 'word' && platform === 'web') {
                        result.banner.text = "YA CAN'T SAVE HERE FORREST -- WORD GOT YA DOC!";
                    } else if (checkedOutBy === 'web' && platform === 'word') {
                        result.banner.text = 'web viewer has doc locked';
                    } else if (checkedOutBy === 'web' && platform === 'web') {
                        result.banner.text = 'doc doc u ... right here right meow';
                    } else if (checkedOutBy === 'word' && platform === 'word') {
                        result.banner.text = 'another word user has doc';
                    } else if (checkedOutBy === 'vendor') {
                        result.banner.text = 'vendor be redlining';
                    }
                }
                return result;
            }
            
            // SUGGESTERS & VENDORS - Can checkout, no override privilege
            if (userRole === 'suggester' || userRole === 'vendor') {
                if (!isCheckedOut) {
                    result.buttons.checkoutBtn = true;
                } else if (isSelfCheckout) {
                    result.buttons.checkedInBtns = true;
                } else {
                    result.banner.show = true;
                    
                    if (checkedOutBy === 'word' && platform === 'web') {
                        result.banner.text = "YA CAN'T SAVE HERE FORREST -- WORD GOT YA DOC!";
                    } else if (checkedOutBy === 'web' && platform === 'word') {
                        result.banner.text = 'web viewer has doc locked';
                    } else if (checkedOutBy === 'web' && platform === 'web') {
                        result.banner.text = 'doc doc u ... right here right meow';
                    } else if (checkedOutBy === 'word' && platform === 'word') {
                        result.banner.text = 'another word user has doc';
                    } else if (checkedOutBy === 'vendor') {
                        result.banner.text = 'vendor be redlining';
                    }
                }
                return result;
            }
            
            console.warn(`‚ö†Ô∏è Unknown user role: ${userRole}`);
            return result;
        }

        // Test scenarios based on USER_STATE_MATRIX.md
        const validationTests = [
            // Key scenarios from the matrix documentation
            {
                name: "Web Editor - Available State",
                input: {
                    userRole: 'editor',
                    platform: 'web',
                    docState: { isCheckedOut: false },
                    currentUser: { id: 'user1', role: 'editor' }
                },
                expected: {
                    buttons: { checkoutBtn: true, overrideBtn: false, sendVendorBtn: true, checkedInBtns: false },
                    banner: { show: false, text: '' }
                }
            },
            {
                name: "Web Editor - Word Checkout (Override Case)",
                input: {
                    userRole: 'editor',
                    platform: 'web',
                    docState: { isCheckedOut: true, checkedOutBy: 'word', checkedOutUser: { id: 'user3' } },
                    currentUser: { id: 'user1', role: 'editor' }
                },
                expected: {
                    buttons: { checkoutBtn: false, overrideBtn: true, sendVendorBtn: false, checkedInBtns: false },
                    banner: { show: true, text: "YA CAN'T SAVE HERE FORREST -- WORD GOT YA DOC!" }
                }
            },
            {
                name: "Web Editor - Self Checkout",
                input: {
                    userRole: 'editor',
                    platform: 'web',
                    docState: { isCheckedOut: true, checkedOutBy: 'web', checkedOutUser: { id: 'user1' } },
                    currentUser: { id: 'user1', role: 'editor' }
                },
                expected: {
                    buttons: { checkoutBtn: false, overrideBtn: false, sendVendorBtn: false, checkedInBtns: true },
                    banner: { show: false, text: '' }
                }
            },
            {
                name: "Web Viewer - Always Banner",
                input: {
                    userRole: 'viewer',
                    platform: 'web',
                    docState: { isCheckedOut: false },
                    currentUser: { id: 'user2', role: 'viewer' }
                },
                expected: {
                    buttons: { checkoutBtn: false, overrideBtn: false, sendVendorBtn: false, checkedInBtns: false },
                    banner: { show: true, text: 'u no change this' }
                }
            },
            {
                name: "Web Suggester - Available (No Override)",
                input: {
                    userRole: 'suggester',
                    platform: 'web',
                    docState: { isCheckedOut: false },
                    currentUser: { id: 'user5', role: 'suggester' }
                },
                expected: {
                    buttons: { checkoutBtn: true, overrideBtn: false, sendVendorBtn: false, checkedInBtns: false },
                    banner: { show: false, text: '' }
                }
            },
            {
                name: "Web Suggester - Word Checkout (No Override)",
                input: {
                    userRole: 'suggester',
                    platform: 'web',
                    docState: { isCheckedOut: true, checkedOutBy: 'word', checkedOutUser: { id: 'user3' } },
                    currentUser: { id: 'user5', role: 'suggester' }
                },
                expected: {
                    buttons: { checkoutBtn: false, overrideBtn: false, sendVendorBtn: false, checkedInBtns: false },
                    banner: { show: true, text: "YA CAN'T SAVE HERE FORREST -- WORD GOT YA DOC!" }
                }
            },
            {
                name: "Word Editor - Vendor Checkout (Override Case)",
                input: {
                    userRole: 'editor',
                    platform: 'word',
                    docState: { isCheckedOut: true, checkedOutBy: 'vendor', checkedOutUser: { id: 'vendor1' } },
                    currentUser: { id: 'user3', role: 'editor' }
                },
                expected: {
                    buttons: { checkoutBtn: false, overrideBtn: true, sendVendorBtn: false, checkedInBtns: false },
                    banner: { show: true, text: 'vendor be redlining' }
                }
            },
            {
                name: "Vendor Self-Checkout",
                input: {
                    userRole: 'vendor',
                    platform: 'web',
                    docState: { isCheckedOut: true, checkedOutBy: 'vendor', checkedOutUser: { id: 'vendor1' } },
                    currentUser: { id: 'vendor1', role: 'vendor' }
                },
                expected: {
                    buttons: { checkoutBtn: false, overrideBtn: false, sendVendorBtn: false, checkedInBtns: true },
                    banner: { show: false, text: '' }
                }
            }
        ];

        function runValidation() {
            const results = document.getElementById('results');
            let html = '<h2>üîç Testing State Matrix Logic</h2>';
            let passCount = 0;
            let failCount = 0;

            validationTests.forEach((test, index) => {
                const { name, input, expected } = test;
                
                // Run the state matrix function
                const actual = getStateMatrixConfig(
                    input.userRole,
                    input.platform,
                    input.docState,
                    input.currentUser
                );

                // Compare results
                const differences = [];
                
                // Check buttons
                Object.keys(expected.buttons).forEach(key => {
                    if (actual.buttons[key] !== expected.buttons[key]) {
                        differences.push(`buttons.${key}: expected ${expected.buttons[key]}, got ${actual.buttons[key]}`);
                    }
                });

                // Check banner
                if (actual.banner.show !== expected.banner.show) {
                    differences.push(`banner.show: expected ${expected.banner.show}, got ${actual.banner.show}`);
                }
                if (actual.banner.text !== expected.banner.text) {
                    differences.push(`banner.text: expected "${expected.banner.text}", got "${actual.banner.text}"`);
                }

                const isPass = differences.length === 0;
                if (isPass) passCount++; else failCount++;

                html += `<div class="test-section">
                    <div class="scenario">${index + 1}. ${name} <span class="${isPass ? 'pass' : 'fail'}">[${isPass ? 'PASS' : 'FAIL'}]</span></div>`;

                if (!isPass) {
                    html += `<div class="fail">‚ùå Differences:</div><ul>`;
                    differences.forEach(diff => html += `<li>${diff}</li>`);
                    html += `</ul>`;
                }

                html += `<div><strong>Input:</strong> ${input.userRole} on ${input.platform}, ${input.docState.isCheckedOut ? 
                    `checked out by ${input.docState.checkedOutBy}` : 'available'}</div>`;
                
                html += `<div><strong>Expected vs Actual:</strong></div>
                    <table>
                        <tr><th>Property</th><th>Expected</th><th>Actual</th></tr>
                        <tr><td>checkoutBtn</td><td>${expected.buttons.checkoutBtn}</td><td>${actual.buttons.checkoutBtn}</td></tr>
                        <tr><td>overrideBtn</td><td>${expected.buttons.overrideBtn}</td><td>${actual.buttons.overrideBtn}</td></tr>
                        <tr><td>sendVendorBtn</td><td>${expected.buttons.sendVendorBtn}</td><td>${actual.buttons.sendVendorBtn}</td></tr>
                        <tr><td>checkedInBtns</td><td>${expected.buttons.checkedInBtns}</td><td>${actual.buttons.checkedInBtns}</td></tr>
                        <tr><td>banner.show</td><td>${expected.banner.show}</td><td>${actual.banner.show}</td></tr>
                        <tr><td>banner.text</td><td>"${expected.banner.text}"</td><td>"${actual.banner.text}"</td></tr>
                    </table>`;

                html += '</div>';
            });

            html += `<div class="test-section">
                <h3>üìä Summary</h3>
                <p><span class="pass">‚úÖ Passed: ${passCount}</span> | <span class="fail">‚ùå Failed: ${failCount}</span></p>
                ${failCount === 0 ? '<div class="pass">üéâ All tests passed! State matrix logic is working correctly.</div>' : ''}
            </div>`;

            results.innerHTML = html;
        }

        // Run validation when page loads
        window.addEventListener('load', runValidation);
    </script>
</body>
</html>
